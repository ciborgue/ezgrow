#include <stdio.h>
#include <assert.h>
/* $Id: test_qrGaloisField.c 611 2013-03-18 05:07:43Z  $ */

#include "qrGaloisField.c"

u_int8_t    alphaGF[GF_SIZE+128];
static int    testAlphaGF[] = { /* {{{ */
    0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x80,
    0x1d,0x3a,0x74,0xe8,0xcd,0x87,0x13,0x26,
    0x4c,0x98,0x2d,0x5a,0xb4,0x75,0xea,0xc9,
    0x8f,0x03,0x06,0x0c,0x18,0x30,0x60,0xc0,
    0x9d,0x27,0x4e,0x9c,0x25,0x4a,0x94,0x35,
    0x6a,0xd4,0xb5,0x77,0xee,0xc1,0x9f,0x23,
    0x46,0x8c,0x05,0x0a,0x14,0x28,0x50,0xa0,
    0x5d,0xba,0x69,0xd2,0xb9,0x6f,0xde,0xa1,
    0x5f,0xbe,0x61,0xc2,0x99,0x2f,0x5e,0xbc,
    0x65,0xca,0x89,0x0f,0x1e,0x3c,0x78,0xf0,
    0xfd,0xe7,0xd3,0xbb,0x6b,0xd6,0xb1,0x7f,
    0xfe,0xe1,0xdf,0xa3,0x5b,0xb6,0x71,0xe2,
    0xd9,0xaf,0x43,0x86,0x11,0x22,0x44,0x88,
    0x0d,0x1a,0x34,0x68,0xd0,0xbd,0x67,0xce,
    0x81,0x1f,0x3e,0x7c,0xf8,0xed,0xc7,0x93,
    0x3b,0x76,0xec,0xc5,0x97,0x33,0x66,0xcc,
    0x85,0x17,0x2e,0x5c,0xb8,0x6d,0xda,0xa9,
    0x4f,0x9e,0x21,0x42,0x84,0x15,0x2a,0x54,
    0xa8,0x4d,0x9a,0x29,0x52,0xa4,0x55,0xaa,
    0x49,0x92,0x39,0x72,0xe4,0xd5,0xb7,0x73,
    0xe6,0xd1,0xbf,0x63,0xc6,0x91,0x3f,0x7e,
    0xfc,0xe5,0xd7,0xb3,0x7b,0xf6,0xf1,0xff,
    0xe3,0xdb,0xab,0x4b,0x96,0x31,0x62,0xc4,
    0x95,0x37,0x6e,0xdc,0xa5,0x57,0xae,0x41,
    0x82,0x19,0x32,0x64,0xc8,0x8d,0x07,0x0e,
    0x1c,0x38,0x70,0xe0,0xdd,0xa7,0x53,0xa6,
    0x51,0xa2,0x59,0xb2,0x79,0xf2,0xf9,0xef,
    0xc3,0x9b,0x2b,0x56,0xac,0x45,0x8a,0x09,
    0x12,0x24,0x48,0x90,0x3d,0x7a,0xf4,0xf5,
    0xf7,0xf3,0xfb,0xeb,0xcb,0x8b,0x0b,0x16,
    0x2c,0x58,0xb0,0x7d,0xfa,0xe9,0xcf,0x83,
    0x1b,0x36,0x6c,0xd8,0xad,0x47,0x8e,0x01
}; /* }}} */
static int    testPowerGF[] = { /* {{{ */
    0x00,0x00,0x01,0x19,0x02,0x32,0x1a,0xc6,
    0x03,0xdf,0x33,0xee,0x1b,0x68,0xc7,0x4b,
    0x04,0x64,0xe0,0x0e,0x34,0x8d,0xef,0x81,
    0x1c,0xc1,0x69,0xf8,0xc8,0x08,0x4c,0x71,
    0x05,0x8a,0x65,0x2f,0xe1,0x24,0x0f,0x21,
    0x35,0x93,0x8e,0xda,0xf0,0x12,0x82,0x45,
    0x1d,0xb5,0xc2,0x7d,0x6a,0x27,0xf9,0xb9,
    0xc9,0x9a,0x09,0x78,0x4d,0xe4,0x72,0xa6,
    0x06,0xbf,0x8b,0x62,0x66,0xdd,0x30,0xfd,
    0xe2,0x98,0x25,0xb3,0x10,0x91,0x22,0x88,
    0x36,0xd0,0x94,0xce,0x8f,0x96,0xdb,0xbd,
    0xf1,0xd2,0x13,0x5c,0x83,0x38,0x46,0x40,
    0x1e,0x42,0xb6,0xa3,0xc3,0x48,0x7e,0x6e,
    0x6b,0x3a,0x28,0x54,0xfa,0x85,0xba,0x3d,
    0xca,0x5e,0x9b,0x9f,0x0a,0x15,0x79,0x2b,
    0x4e,0xd4,0xe5,0xac,0x73,0xf3,0xa7,0x57,
    0x07,0x70,0xc0,0xf7,0x8c,0x80,0x63,0x0d,
    0x67,0x4a,0xde,0xed,0x31,0xc5,0xfe,0x18,
    0xe3,0xa5,0x99,0x77,0x26,0xb8,0xb4,0x7c,
    0x11,0x44,0x92,0xd9,0x23,0x20,0x89,0x2e,
    0x37,0x3f,0xd1,0x5b,0x95,0xbc,0xcf,0xcd,
    0x90,0x87,0x97,0xb2,0xdc,0xfc,0xbe,0x61,
    0xf2,0x56,0xd3,0xab,0x14,0x2a,0x5d,0x9e,
    0x84,0x3c,0x39,0x53,0x47,0x6d,0x41,0xa2,
    0x1f,0x2d,0x43,0xd8,0xb7,0x7b,0xa4,0x76,
    0xc4,0x17,0x49,0xec,0x7f,0x0c,0x6f,0xf6,
    0x6c,0xa1,0x3b,0x52,0x29,0x9d,0x55,0xaa,
    0xfb,0x60,0x86,0xb1,0xbb,0xcc,0x3e,0x5a,
    0xcb,0x59,0x5f,0xb0,0x9c,0xa9,0xa0,0x51,
    0x0b,0xf5,0x16,0xeb,0x7a,0x75,0x2c,0xd7,
    0x4f,0xae,0xd5,0xe9,0xe6,0xe7,0xad,0xe8,
    0x74,0xd6,0xf4,0xea,0xa8,0x50,0x58,0xaf
}; /* }}} */
void test_initGF(void) { /* {{{ */
    int i;
    initGF(alphaGF);
    printf("Testing initGF ");
    for (i=0; i<GF_SIZE; i++) {
        assert(alphaGF[i]==testAlphaGF[i]);
        assert(powerGF(alphaGF,i)==testPowerGF[i]);
    }
    for (i=0; i<GF_SIZE-1; i++) {
        /* fprintf(stderr,"%d\n", i); */
        assert(powerGF(alphaGF,alphaGF[i])==i);
    }

    printf("ok\n");
} /* }}} */
void test_genGF(void) { /* {{{ */
    static int ecc[] = { /* possible ECC lengths */
        7, 10, 13, 15, 16, 17, 18, 20, 22, 24, 26, 28,
        30, 32, 34, 36, 40, 42, 44, 46, 48, 50, 52, 54,
        56, 58, 60, 62, 64, 66, 68, -1
    };
    static struct {
        int	power;
        u_int8_t	p[128]; /* 68 is enough */
    } data[] = { /* {{{ */
        {7,{21,102,238,149,146,229,87}},
        {10,{45,32,94,64,70,118,61,46,67,251}},
        {13,{78,140,206,218,130,104,106,100,86,100,176,152,74}},
        {15,{105,99,5,124,140,237,58,58,51,37,202,91,61,183,8}},
        {16,{120,225,194,182,169,147,191,91,3,76,161,102,109,107,104,120}},
        {17,{136,163,243,39,150,99,24,147,214,206,123,239,43,78,206,139,43}},
        {18,{153,96,98,5,179,252,148,152,187,79,170,118,97,184,94,158,234,215}},
        {20,{190,188,212,212,164,156,239,83,225,221,180,202,187,26,163,61,50,79,60,17}},
        {22,{231,165,105,160,134,219,80,98,172,8,74,200,53,221,109,14,230,93,242,247,171,210}},
        {24,{21,227,96,87,232,117,0,111,218,228,226,192,152,169,180,159,126,251,117,211,48,135,121,229}},
        {26,{70,218,145,153,227,48,102,13,142,245,21,161,53,165,28,111,201,145,17,118,182,103,2,158,125,173}},
        {28,{123,9,37,242,119,212,195,42,87,245,43,21,201,232,27,205,147,195,190,110,180,108,234,224,104,200,223,168}},
        {30,{180,192,40,238,216,251,37,156,130,224,193,226,173,42,125,222,96,239,86,110,48,50,182,179,31,216,152,145,173,41}},
        {32,{241,220,185,254,52,80,222,28,60,171,69,38,156,80,185,120,27,89,123,242,32,138,138,209,67,4,167,249,190,106,6,10}},
        {34,{51,129,62,98,13,167,129,183,61,114,70,56,103,218,239,229,158,58,125,163,140,86,193,113,94,105,19,108,21,26,94,146,77,111}},
        {36,{120,30,233,113,251,117,196,121,74,120,177,105,210,87,37,218,63,18,107,238,248,113,152,167,0,115,152,60,234,246,31,172,16,98,183,200}},
        {40,{15,35,53,232,20,72,134,125,163,47,41,88,114,181,35,175,7,170,104,226,174,187,26,53,106,235,56,163,57,247,161,128,205,128,98,252,161,79,116,59}},
        {42,{96,50,117,194,162,171,123,201,254,237,199,213,101,39,223,101,34,139,131,15,147,96,106,188,8,230,84,110,191,221,242,58,3,0,231,137,18,25,230,221,103,250}},
        {44,{181,73,102,113,130,37,169,204,147,217,194,52,163,68,114,118,126,224,62,143,78,44,238,1,247,14,145,9,123,72,25,191,243,89,188,168,55,69,246,71,121,61,7,190}},
        {46,{15,82,19,223,202,43,224,157,25,52,174,119,245,249,8,234,104,73,241,60,96,4,1,36,211,169,216,135,16,58,44,129,113,54,5,89,99,187,115,202,224,253,112,88,94,112}},
        {48,{108,34,39,163,50,84,227,94,11,191,238,140,156,247,21,91,184,120,150,95,206,107,205,182,160,135,111,221,18,115,123,46,63,178,61,240,102,39,90,251,24,60,146,211,130,196,25,228}},
        {50,{205,133,232,215,170,124,175,235,114,228,69,124,65,113,32,189,42,77,75,242,215,242,160,130,209,126,160,32,13,46,225,203,242,195,111,209,3,35,193,203,99,209,46,118,9,164,161,157,125,232}},
        {52,{51,116,254,239,33,101,220,200,242,39,97,86,76,22,121,235,233,100,113,124,65,59,94,190,89,254,134,203,242,37,145,59,14,22,215,151,233,184,19,124,127,86,46,192,89,251,220,50,186,86,50,116}},
        {54,{156,31,76,198,31,101,59,153,8,235,201,128,80,215,108,120,43,122,25,123,79,172,175,238,254,35,245,52,192,184,95,26,165,109,218,209,58,102,225,249,184,238,50,45,65,46,21,113,221,210,87,201,26,183}},
        {56,{10,61,20,207,202,154,151,247,196,27,61,163,23,96,206,152,124,101,184,239,85,10,28,190,174,177,249,182,142,127,139,12,209,170,208,135,155,254,144,6,229,202,201,36,163,248,91,2,116,112,216,164,157,107,120,106}},
        {58,{123,148,125,233,142,159,63,41,29,117,245,206,134,127,145,29,218,129,6,214,240,122,30,24,23,125,165,65,142,253,85,206,249,152,248,192,141,176,237,154,144,210,242,251,55,235,185,200,182,252,107,62,27,66,247,26,116,82}},
        {60,{240,33,7,89,16,209,27,70,220,190,102,65,87,194,25,84,181,30,124,11,86,121,209,160,49,238,38,37,82,160,109,101,219,115,57,198,205,2,247,100,6,127,181,28,120,219,101,211,45,219,197,226,197,243,141,9,12,26,140,107}},
        {62,{106,110,186,36,215,127,218,182,246,26,100,200,6,115,40,213,123,147,149,229,11,235,117,221,35,181,126,212,17,194,111,70,50,72,89,223,76,70,118,243,78,135,105,7,121,58,228,2,23,37,122,0,94,214,118,248,223,71,98,113,202,65}},
        {64,{231,213,156,217,243,178,11,204,31,242,230,140,108,99,63,238,242,125,195,195,140,47,146,184,47,91,216,4,209,218,150,208,156,145,24,29,212,199,93,160,53,127,26,119,149,141,78,200,254,187,204,177,123,92,119,68,49,159,158,7,9,175,51,45}},
        {66,{105,45,93,132,25,171,106,67,146,76,82,168,50,106,232,34,77,217,126,240,253,80,87,63,143,121,40,236,111,77,154,44,7,95,197,169,214,72,41,101,95,111,68,178,137,65,173,95,171,197,247,139,17,81,215,13,117,46,51,162,136,136,180,222,118,5}},
        {68,{238,163,8,5,3,127,184,101,27,235,238,43,198,175,215,82,32,54,2,118,225,166,241,137,125,41,177,52,231,95,97,199,52,227,89,160,173,253,84,15,84,93,151,203,220,165,202,60,52,133,205,190,101,84,150,43,254,32,160,90,70,77,93,224,33,223,159,247}},
        {-1}
    }; /* }}} */
    int	    i,j;
    u_int8_t    p[70];

    printf("Testing polynoms ");
    initGF(alphaGF);
    for (i=0; ecc[i]!=-1; i++) {
        printf(".");
        genGF(alphaGF, ecc[i], p);
        for (j=0; j<ecc[i]; j++)
            assert(data[i].p[j]==powerGF(alphaGF,p[j]));
    }
    printf(" ok\n");
} /* }}} */
void test_LSFR(void) { /* {{{ */
    u_int8_t    *src;
    static struct {
	u_int8_t	power;
	u_int8_t    len;
	u_int8_t    ecc[70];
	u_int8_t    msg[768];
    } data[] = { /* {{{ */
	{10,16, /* this is from the ISO document Annex ? */
	    { 0xa5,0x24,0xd4,0xc1,0xed,0x36,0xc7,0x87,0x2c,0x55 },
	    { 0x10,0x20,0x0c,0x56,0x61,0x80,0xec,0x11,
            0xec,0x11,0xec,0x11,0xec,0x11,0xec,0x11 }
	},
#include "qrECCdata.h"
	{0}
    }; /* }}} */
    int i,j;
    u_int8_t    buffer[QRBUFFER];

    printf("Testing LSRF function ");
    for (i=0; data[i].power; i++) {
        printf(".");
        src = data[i].msg ;
        /* test with a designated buffer */
        qrReedSolomon(data[i].power,data[i].len,src,src+data[i].len,buffer);
        for (j=0; j<data[i].power; j++) {
            assert(data[i].ecc[j]==src[data[i].len+j]);
        }
    }
    printf(" ok\n");
} /* }}} */

int main(void) { /* {{{ */
    test_initGF();
    test_genGF();
    test_LSFR();

    return 0;
} /* }}} */
