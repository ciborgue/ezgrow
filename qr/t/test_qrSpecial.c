/* $Id: test_qrSpecial.c 657 2013-04-13 03:42:40Z  $ */
#define UNICODE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <getopt.h>
#include <strings.h>
#include <locale.h>
#include <sys/types.h>
#include <assert.h>

#include "qrEnum.h"
#include "qrMatrix.h"

#include "qrMatrix.c"

struct { /* {{{ */
    int ver;
    int x,y;
    int8_t sptl[10]; /* data, soft?, hard?, Border?, VersionInfo?,
                       FormatInfo?, Finder?, Alignment?, Timing? */
} data[] = {
    /*    x   y   d  s  h  B  V  F  F  A  T */
    /*            t  o  a  o  e  o  i  l  i */
    /* out of border      */
    { 0, -1, -1, {2, 0, 1, 1, 0, 0, 0, 0, 0}},
    { 0,  0, 21, {2, 0, 1, 1, 0, 0, 0, 0, 0}},
    { 0, 21,  0, {2, 0, 1, 1, 0, 0, 0, 0, 0}},
    { 0, 21, 21, {2, 0, 1, 1, 0, 0, 0, 0, 0}},
    { 0, 10, 10, {2, 0, 0, 0, 0, 0, 0, 0, 0}},

    /* finder upper-left  */
    { 0,  3,  3, {1, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0,  0,  0, {1, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0,  7,  0, {0, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0,  0,  7, {0, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0,  7,  7, {0, 0, 1, 0, 0, 0, 1, 0, 0}},

    /* finder upper-right */
    { 0, 17,  3, {1, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0, 20,  0, {1, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0, 13,  0, {0, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0, 20,  7, {0, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0, 13,  7, {0, 0, 1, 0, 0, 0, 1, 0, 0}},

    /* finder lower-left  */
    { 0,  3, 17, {1, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0,  0, 20, {1, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0,  7, 20, {0, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0,  7, 13, {0, 0, 1, 0, 0, 0, 1, 0, 0}},
    { 0,  0, 13, {0, 0, 1, 0, 0, 0, 1, 0, 0}},

    /* format info        */
    { 0,  8,  0, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8,  1, {1, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},

    /* special dark pixel */
    { 0,  8, 13, {1, 0, 1, 0, 0, 1, 0, 0, 0}},

    /* timing patterns: h */
    { 0,  8,  6, {1, 1, 0, 0, 0, 0, 0, 0, 1}},
    { 0,  9,  6, {0, 1, 0, 0, 0, 0, 0, 0, 1}},
    { 0, 10,  6, {1, 1, 0, 0, 0, 0, 0, 0, 1}},
    { 0, 11,  6, {0, 1, 0, 0, 0, 0, 0, 0, 1}},
    { 0, 12,  6, {1, 1, 0, 0, 0, 0, 0, 0, 1}},

    /* timing patterns: v */
    { 0,  6,  8, {1, 1, 0, 0, 0, 0, 0, 0, 1}},
    { 0,  6,  9, {0, 1, 0, 0, 0, 0, 0, 0, 1}},
    { 0,  6, 10, {1, 1, 0, 0, 0, 0, 0, 0, 1}},
    { 0,  6, 11, {0, 1, 0, 0, 0, 0, 0, 0, 1}},
    { 0,  6, 12, {1, 1, 0, 0, 0, 0, 0, 0, 1}},

    /* format info        */
    { 0,  8,  0, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8,  1, {1, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8,  2, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8,  3, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8,  4, {1, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8,  5, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8,  7, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  7,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  5,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  4,  8, {1, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  3,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  2,  8, {1, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  1,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  0,  8, {1, 0, 1, 0, 0, 1, 0, 0, 0}},

    { 0, 20,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0, 19,  8, {1, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0, 18,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0, 17,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0, 16,  8, {1, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0, 15,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0, 14,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0, 13,  8, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8, 14, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8, 15, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8, 16, {1, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8, 17, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8, 18, {1, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8, 19, {0, 0, 1, 0, 0, 1, 0, 0, 0}},
    { 0,  8, 20, {1, 0, 1, 0, 0, 1, 0, 0, 0}},

    /* alignment           */
    { 1, 16, 16, {1, 1, 0, 0, 0, 0, 0, 1, 0}},
    { 1, 20, 16, {1, 1, 0, 0, 0, 0, 0, 1, 0}},
    { 1, 16, 20, {1, 1, 0, 0, 0, 0, 0, 1, 0}},
    { 1, 20, 20, {1, 1, 0, 0, 0, 0, 0, 1, 0}},

    /* version information: v */
    { 6, 34,  0, {2, 0, 1, 0, 1, 0, 0, 0, 0}},
    { 6, 36,  0, {2, 0, 1, 0, 1, 0, 0, 0, 0}},
    { 6, 34,  5, {2, 0, 1, 0, 1, 0, 0, 0, 0}},
    { 6, 36,  5, {2, 0, 1, 0, 1, 0, 0, 0, 0}},

    /* version information: h */
    { 6,  0, 34, {2, 0, 1, 0, 1, 0, 0, 0, 0}},
    { 6,  0, 36, {2, 0, 1, 0, 1, 0, 0, 0, 0}},
    { 6,  5, 34, {2, 0, 1, 0, 1, 0, 0, 0, 0}},
    { 6,  5, 36, {2, 0, 1, 0, 1, 0, 0, 0, 0}},

    { 6, 40, 40, {1, 1, 0, 0, 0, 0, 0, 1, 0}},
    {-1,  0,  0, {0, 0, 0, 0, 0, 0, 0, 0, 0}},
}; /* }}} */
int main(int argc, char *argv[]) {
    static pixel_t (* const special[])(hint_t, int, int) = {
        &qrIsVersionInfo, &qrIsFormatInfo, &qrIsFinder,
        &qrIsAlignment, &qrIsTiming, NULL
    };
    hint_t   ver;
    pixel_t pix;
    int     i,j,x,y;

    printf("Testing various qrIs* functions ");
    for (i=0; data[i].ver != -1; i++) {
        ver.ver = data[i].ver;
        ver.ecc = ver.xor = 0; /* for qrFormatInfo */
        x = data[i].x;
        y = data[i].y;

        printf(".");

        pix = qrOutOfBorder(ver,x,y);
        assert(pix.valid == data[i].sptl[3]);
        if (pix.valid) {
            continue; /* qrOutOfBorder? */
        }
        for (j=0; special[j] != NULL; j++) {
            pix = (*(special[j]))(ver,x,y);
            assert(pix.valid == data[i].sptl[j+4]);
            if (0) {
                fprintf(stderr,"%d,%d %d %d %d\n", x, y,
                    pix.valid, pix.hard, pix.soft);
            }
            if (!pix.valid) {
                continue; /* pixel is invalid */
            }
            if (data[i].sptl[0] == 0 || data[i].sptl[0] == 1) {
                assert(pix.data == data[i].sptl[0]);
            }
            assert(pix.hard == data[i].sptl[2]);
            assert(pix.soft == data[i].sptl[1]);
        }
    }
    printf(" done\n");

    /*
    printf("%d %d %d : ", ver.ver, data[i].x, data[i].y);
    printf("%d %d\n", pix.valid, pix.data);
    */
    return 0;
}
